##################################################################################################
# hoobs-image                                                                                    #
# rpi-gen                                                                                        #
# Copyright (C) 2015 Raspberry Pi (Trading) Ltd.                                                 #
#                                                                                                #
# This program is free software: you can redistribute it and/or modify                           #
# it under the terms of the GNU General Public License as published by                           #
# the Free Software Foundation, either version 3 of the License, or                              #
# (at your option) any later version.                                                            #
#                                                                                                #
# This program is distributed in the hope that it will be useful,                                #
# but WITHOUT ANY WARRANTY; without even the implied warranty of                                 #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                  #
# GNU General Public License for more details.                                                   #
#                                                                                                #
# You should have received a copy of the GNU General Public License                              #
# along with this program.  If not, see <http://www.gnu.org/licenses/>.                          #
##################################################################################################

dependencies_check()
{
    local depfile deps missing

    for depfile in "$@"; do
        if [[ -e "$depfile" ]]; then
            deps="$(sed -f "${SCRIPT_DIR}/remove-comments.sed" < "${BASE_DIR}/depends")"

        fi
        for dep in $deps; do
            if ! hash "${dep%:*}" 2>/dev/null; then
                missing="${missing:+$missing }${dep#*:}"
            fi
        done
    done

    if [[ "$missing" ]]; then
        echo "Required dependencies not installed"
        echo
        echo "This can be resolved on Debian/Raspbian systems by installing:"
        echo "$missing"
        false
    fi

    if ! grep -q "/proc/sys/fs/binfmt_misc" /proc/mounts; then
        echo "Module binfmt_misc not loaded in host"
        echo "Please run:"
        echo "  sudo modprobe binfmt_misc"
        exit 1
    fi
}
