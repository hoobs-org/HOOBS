#!/bin/bash

edit() {
    case $1 in
        scripts )
            nano ./project
            ;;

        * )
            nano ./HOOBS.code-workspace
            ;;
    esac
}

clone() {
    printf "\033[0;36mCloning $1\033[0m\n"

    case $1 in
        console )
            [[ -d console ]] || git clone https://github.com/hoobs-org/helm.git
            [[ -d console ]] || mv helm console
            (cd console && git checkout blackwing)
            ;;

        repo | security )
            [[ -d $1 ]] || git clone https://github.com/hoobs-org/$1.git
            ;;

        * )
            [[ -d $1 ]] || git clone https://github.com/hoobs-org/$1.git
            (cd $1 && git checkout blackwing)
            ;;
    esac
}

install() {
    printf "\033[0;36mInstalling $1\033[0m\n"

    (cd $1 && ../node_modules/.bin/yarn install --ignore-engines)
}

push() {
    printf "\033[0;36mPushing $1\033[0m\n"

    (cd $1 && git push)
}

pull() {
    printf "\033[0;36mPulling $1\033[0m\n"

    case $1 in
        repo | security )
            (cd $1 && git pull)
            ;;

        * )
            (cd $1 && git pull && git checkout blackwing)
            ;;
    esac
}

yarn() {
    COMMAND=$1
    PROJECT=$2

    shift
    shift

    case $PROJECT in
        cli | console | desktop | gui | hoobsd | network | pam | portal | sdk | image )
            case $COMMAND in
                install )
                    printf "\033[0;36mInstall $PROJECT\033[0m\n"

                    (cd $PROJECT && ../node_modules/.bin/yarn install)
                    ;;

                add )
                    printf "\033[0;36mAdd $PROJECT\033[0m\n"

                    (cd $PROJECT && ../node_modules/.bin/yarn add $@)
                    ;;

                remove )
                    printf "\033[0;36mRemove $PROJECT\033[0m\n"

                    (cd $PROJECT && ../node_modules/.bin/yarn remove $@)
                    ;;
            esac
            ;;
    esac
}

version() {
    PROJECT=$1

    shift

    case $PROJECT in
        cli | gui | desktop | hoobsd | sdk | portal | console | network | pam | image )
            (cd $PROJECT && ./project version $@)
            ;;
    esac
}

lint() {
    case $1 in
        cli | gui | desktop | hoobsd | sdk | portal | console | network )
            printf "\033[0;36mLint $1\033[0m\n"

            (cd $1 && ./project lint)
            ;;
    esac
}

debug() {
    PROJECT=$1

    shift

    case $PROJECT in
        hoobsd )
            (cd cli && ./project debug -v)
            (cd $PROJECT && ./project debug $@)
            ;;

        cli | gui | hoobsd | portal | console )
            (cd $PROJECT && ./project debug $@)
            ;;
    esac
}

build() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "the toolchain can not be ran on macos"

        exit 1
    fi

    PROJECT=$1

    shift

    case $PROJECT in
        desktop)
            VERSION=$(./desktop/project version)

            mkdir -p desktop/

            if [ -f .env ]; then
                . .env
            fi

            eval "sshpass -p '$DARWIN_PASSWD' ssh -o 'StrictHostKeyChecking no' $DARWIN_USER@$DARWIN_HOST 'source /etc/profile; (cd $PROJECT_PATH/desktop && ./project build)'"
            eval "sshpass -p '$DARWIN_PASSWD' scp -o 'StrictHostKeyChecking no' $DARWIN_USER@$DARWIN_HOST:$PROJECT_PATH/desktop/builds/hoobs-desktop-v$VERSION.* ./desktop/builds/"
            ;;

        localization )
            printf "\033[0;36mBuild $PROJECT\033[0m\n"

            (cd lang && ./build)
            ;;

        cli | gui | hoobsd | sdk | portal | console | network | pam | image )
            printf "\033[0;36mBuild $PROJECT\033[0m\n"

            (cd $PROJECT && ./project build $@)
            ;;
    esac
}

rebuild() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "the toolchain can not be ran on macos"

        exit 1
    fi

    case $1 in
        image )
            printf "\033[0;36mRebuild $1\033[0m\n"

            (cd $1 && ./project rebuild)
            ;;
    esac
}

publish() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "the toolchain can not be ran on macos"

        exit 1
    fi

    PROJECT=$1

    shift

    case $PROJECT in
        list )
            list $@
            ;;

        cli | gui | desktop | hoobsd | sdk | portal | console | network | pam | image )
            printf "\033[0;36mPublish $PROJECT\033[0m\n"

            (cd $PROJECT && ./project publish $@)
            ;;
    esac
}

list() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "the toolchain can not be ran on macos"

        exit 1
    fi

    case $1 in
        stable | edge | bleeding )
            reprepro -b ./repo/debian list $1
            ;;

        * )
            reprepro -b ./repo/debian list stable
            reprepro -b ./repo/debian list edge
            reprepro -b ./repo/debian list bleeding
            ;;
    esac
}

clean() {
    case $1 in
        cli | gui | desktop | hoobsd | sdk | portal | console | network | pam | image )
            printf "\033[0;36mClean $1\033[0m\n"

            (cd $1 && ./project clean)
            ;;
    esac 
}

case $1 in
    edit )
        shift
        edit $@
        ;;

    setup )
        if [[ "|$(command -v apt-get)|" != "||" ]]; then
            sudo apt-get update
            sudo apt-get install -y curl wget vmdb2 dosfstools f2fs-tools debootstrap binfmt-support time kpartx bmap-tools reprepro ca-certificates dpkg make git
            sudo apt-get install -y gcc g++ gcc-arm-linux-gnueabi libc6-dev libc6-dev-armel-cross libc6-dev-armhf-cross libc6-dev-arm64-cross libc6-dev-i386-cross
            sudo apt-get install -y qemu-utils qemu-user-static qemu-system-arm fakemachine libpam-dev dpkg-sig

            git config --global pull.rebase false
            git config --global credential.helper store

            curl -s https://deb.nodesource.com/gpgkey/nodesource.gpg.key | sudo gpg --dearmor | sudo tee /usr/share/keyrings/nodesource.gpg > /dev/null
            curl -s https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor | sudo tee /usr/share/keyrings/github.gpg > /dev/null

            echo "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_14.x bullseye main" | sudo tee /etc/apt/sources.list.d/nodesource.list
            echo "deb-src [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_14.x bullseye main" | sudo tee -a /etc/apt/sources.list.d/nodesource.list
            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/github.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github.list

            sudo apt-get update
            sudo apt-get install -y gh nodejs nano python3-minimal python3-pip sshpass

            gpg --import ./security/repo/publickey.gpg && gpg --allow-secret-key-import --import ./security/repo/privatekey.gpg
            sudo gpg --import ./security/repo/publickey.gpg && sudo gpg --allow-secret-key-import --import ./security/repo/privatekey.gpg
        fi

        npm install

        clone cli
        clone console
        clone desktop
        clone gui
        clone hoobsd
        clone image
        clone network
        clone pam
        clone portal
        clone repo
        clone sdk
        clone security

        install cli
        install console
        install desktop
        install gui
        install hoobsd
        install network
        install pam
        install portal
        install sdk
        ;;

    push )
        git push

        push cli
        push console
        push desktop
        push gui
        push hoobsd
        push image
        push network
        push pam
        push portal
        push repo
        push sdk
        push security
        ;;

    pull )
        git pull
        npm install

        pull cli
        pull console
        pull desktop
        pull gui
        pull hoobsd
        pull image
        pull network
        pull pam
        pull portal
        pull repo
        pull sdk
        pull security

        install cli
        install console
        install desktop
        install gui
        install hoobsd
        install network
        install pam
        install portal
        install sdk
        ;;

    install )
        shift
        yarn install $@
        ;;

    add )
        shift
        yarn add $@
        ;;

    remove )
        shift
        yarn remove $@
        ;;

    cache )
        shift
        ./node_modules/.bin/yarn cache $@
        ;;

    version )
        shift
        version $@
        ;;

    lint )
        shift
        lint $@
        ;;

    debug )
        shift
        debug $@
        ;;

    build )
        shift
        build $@
        ;;

    rebuild )
        shift
        rebuild $@
        ;;

    publish )
        shift
        publish $@
        ;;

    clean )
        shift
        clean $@
        ;;
esac
